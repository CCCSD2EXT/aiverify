# Pre-build Checks (Portal)
# 1. Unit tests with code coverage (jest)
# 2. Code quality analysis (lint)
# 3. Dependency analysis (vulnerabilities)
# 4. Dependency analysis (undesirable licenses)

name: v2 Pre-build Checks (portal)

on:
  # Runs when a pull request to main is being assigned
  pull_request:
    types: [assigned, synchronize]
    branches:
      - "main"
    paths:
      - "aiverify-portal/**"
      - "aiverify-shared-library/**"

  # Run this workflow manually from Actions tab
  workflow_dispatch:
    inputs:
      branch_to_test:
        description: 'Branch or tag to run test'
        required: true
        default: 'main'
        type: string

  push:
    branches: [ci/pre-build-check-2]

# Allow one concurrent deployment
concurrency:
  group: ${{ github.repository }}-${{ github.workflow }}
  cancel-in-progress: true
  
jobs:
  
    pre-build-checks:
      # Run only when PR is assigned, even on subsequent commits (i.e. synchronize)
      if: (github.event_name == 'pull_request' && github.event.pull_request.assignee != null) || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
      runs-on: ubuntu-latest    
      timeout-minutes: 40
  
      steps:
  
        - name: Set env variables
          run: |
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              echo "BRANCH_TO_TEST=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
              echo "PR_NUM=#${{ github.event.pull_request.number }}" >> $GITHUB_ENV
            elif [ "${{ github.event_name }}" == "push" ]; then
              echo "BRANCH_TO_TEST=${{ github.ref }}" >> $GITHUB_ENV
              echo "PR_NUM=#000" >> "$GITHUB_ENV"
            elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
              echo "BRANCH_TO_TEST=${{ inputs.branch_to_test }}" >> $GITHUB_ENV
              echo "PR_NUM=#000" >> "$GITHUB_ENV"
            fi
            echo "WDIR=aiverify-portal" >> $GITHUB_ENV
            echo "CI_DIR=../.ci" >> $GITHUB_ENV
  
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            ref: ${{ env.BRANCH_TO_TEST }}
            sparse-checkout: |
              aiverify-portal
              aiverify-shared-library
              common
              .ci
    
        - name: Setup Node.js 23
          uses: actions/setup-node@v4
          with:
            node-version: '23'

        # Install dependencies
        - name: Setup npm cache/install
          uses: actions/setup-node@v3
          with:
            node-version: 18
            cache: "npm"
            cache-dependency-path: ai-verify-portal

        - name: Install dependencies for shared-library
          working-directory: ${{ github.workspace }}/aiverify-shared-library
          run: |
            npm install --omit=dev
            npx license-checker --summary --out licenses-found.txt -y
            npm install -D
            npm run build

        - name: Install dependencies for portal
          working-directory: ${{ github.workspace }}/aiverify-portal
          run: |
            npm install --omit=dev
            npx license-checker --summary --out licenses-found.txt -y
            npm install -D
            npm i -D eslint-formatter-html
            npm link ../aiverify-shared-library

        # Compile typescript source files
        - name: Build portal (next build)
          working-directory: ${{ github.workspace }}/aiverify-portal
          run: |
            cp .env.development .env
            npm run build

        # Format check
        - name: Format check
          if: ${{ ! cancelled() }}
          working-directory: ${{ github.workspace }}/aiverify-portal
          run: |
            # npm run format-check
            npx prettier --check .

        # Unit Tests & Coverage
        - name: Unit tests with coverage
          if: ${{ ! cancelled() }}
          working-directory: ${{ github.workspace }}/aiverify-portal
          timeout-minutes: 30
          run: |
            set +e
            sudo timedatectl set-timezone Asia/Singapore
            # npm run coverage
            npx jest --silent 
            exit_code_jest=$?
            set -e
            if [ $exit_code_jest -ne 0 ]; then
              echo "jest failed, exiting..."
              exit $exit_code_jest
            fi

        # eslint
        - name: Code quality analysis - lint
          if: ${{ ! cancelled() }}
          working-directory: ${{ github.workspace }}/aiverify-portal
          run: |
            set +e
            npm run lint
            exit_code_lint=$?
            # npm run lint-html-report
            # npm run lint-json-report
            npm run lint -f html -o eslint-report.html
            npm run lint -f json -o eslint-report.json
            set -e
            if [ $exit_code_lint -ne 0 ]; then
              echo "lint failed, exiting..."
              exit $exit_code_lint
            fi

        # npm audit
        - name: Dependency analysis - vulnerabilities & licenses
          if: ${{ ! cancelled() }}
          working-directory: ${{ github.workspace }}/aiverify-portal
          run: |
            set +e
            npm audit --omit=dev
            exit_code_audit=$?         
            npm audit --omit=dev --json | npx npm-audit-markdown --output npm-audit-report.md
            npx markdown-to-html-cli --source npm-audit-report.md --output npm-audit-report.html -y
            echo -e "License Check Summary for portal\n" > license-report.txt
            cat licenses-found.txt >> license-report.txt
            echo -e "\nLicense Check Summary for shared-library\n" >> license-report.txt
            cat ../ai-verify-shared-library/licenses-found.txt >> license-report.txt
            cat license-report.txt
            cp license-report.txt licenses-found.txt
            set -e
            if [ $exit_code_audit -ne 0 ]; then
              echo "npm audit failed, exiting..."
              exit $exit_code_audit
            fi

        # ### Publish reports to ci dashboard ###

        # - name: Checkout dashboard
        #   if: ${{ github.event.pull_request.head.repo.full_name == github.repository && always() }}
        #   uses: actions/checkout@v3
        #   with:
        #     repository: aiverify-foundation/ci-dashboard
        #     token: ${{ secrets.CHECKOUT_TOKEN }}
        #     ref: main
        #     path: check-results

        # - name: Push results to dashboard
        #   if: ${{ github.event.pull_request.head.repo.full_name == github.repository && always() }}
        #   working-directory: ${{ github.workspace }}/check-results
        #   run: |
        #     set +e
        #     find ../ -type f -name ".gitignore" -exec rm {} +
        #     [ -d "docs/pre-merge/portal" ] && rm -rf docs/pre-merge/portal
        #     mkdir -p docs/pre-merge/portal
        #     mv ../ai-verify-portal/coverage docs/pre-merge/portal/
        #     mv ../ai-verify-portal/*.svg docs/pre-merge/portal/
        #     mv ../ai-verify-portal/*.html docs/pre-merge/portal/
        #     mv ../ai-verify-portal/*.md docs/pre-merge/portal/
        #     mv ../ai-verify-portal/*.txt docs/pre-merge/portal/
        #     git add docs/pre-merge/portal
        #     git config user.name "aiverify"
        #     git config user.email "aiverify@imda.gov.sg"
        #     git commit -m "feat(portal) actions publish portal reports to dashboard"
        #     git push
        #     set -e
